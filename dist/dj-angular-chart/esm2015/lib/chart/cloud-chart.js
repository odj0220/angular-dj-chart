import * as d3 from 'd3';
import * as _d3Cloud from 'd3-cloud';
import * as _ from 'lodash';
import { BaseMixin } from '../base/base-mixin';
const d3Cloud = _d3Cloud;
export class CloudChart extends BaseMixin {
    constructor(element, option) {
        super();
        this.element = element;
        this.option = option;
        this._scale = [15, 70];
        this._color = d3.schemeCategory10;
        this._padding = 2;
        this._width = 100;
        this._height = 100;
    }
    render() {
        if (this.svg()) {
            // @ts-ignore
            this.svg().remove();
        }
        this.chartRender();
        return this;
    }
    redraw() {
        this.render();
        return this;
    }
    width(width) {
        if (!width) {
            this._width = this.option.width ? this.option.width : this.element.clientWidth;
            return this._width;
        }
        this._width = width;
        return this;
    }
    height(height) {
        if (!height) {
            this._height = this.option.height ? this.option.height : this.element.clientHeight;
            return this._height;
        }
        this._height = height;
        return this;
    }
    legends(object) {
        if (!object) {
            return this._legends;
        }
        this._legends = object;
        return this;
    }
    padding(padding) {
        if (!padding) {
            return this._padding;
        }
        this._padding = padding;
        return this;
    }
    color(color) {
        if (!color) {
            return this._customColor ? this._customColor : this._color;
        }
        this._customColor = color;
        return this;
    }
    dimension(dimension) {
        if (!dimension) {
            return this._dimension;
        }
        this._dimension = dimension;
        return this;
    }
    group(object) {
        if (!object) {
            return this._group;
        }
        this._group = object;
        return this;
    }
    chartRender() {
        // @ts-ignore
        const data = this._group.all();
        const fontScale = d3.scaleLinear().range(this._scale);
        const domain = [d3.min(data, (d) => d.value), d3.max(data, (d) => d.value)];
        // @ts-ignore
        fontScale.domain(domain);
        // @ts-ignore
        d3Cloud()
            .size([this._width, this._height])
            .words(data)
            .padding(this._padding)
            .rotate(0)
            .font('sans-serif')
            .text((d) => {
            let key = d.key || d.keys;
            key = typeof key === 'string' ? key : key[0];
            if (this._legends && this._legends[key]) {
                key = this._legends[key];
            }
            return key;
        })
            .fontSize((d) => fontScale(d.value))
            .on('end', this.draw.bind(this))
            .start();
    }
    svg() {
        // @ts-ignore
        if (!d3.select(this.element).select('svg')._groups[0][0]) {
            return;
        }
        return d3.select(this.element).select('svg');
    }
    draw(words) {
        const cloud = d3.select(this.element).append('svg')
            .attr('class', 'wise-chart-cloud')
            .attr('width', this._width)
            .attr('height', this._height)
            .append('g')
            .attr('transform', 'translate(' + this._width / 2 + ',' + this._height / 2 + ')')
            .selectAll('text')
            .data(words)
            .enter().append('text')
            .style('font-size', (d) => d.size + 'px')
            .style('font-family', 'sans-serif')
            .style('fill', (d, i) => {
            return this._customColor ? this._customColor[d.key[0]] : this._color[i % this._color.length];
        })
            .style('opacity', (d, i) => {
            if (this['filters']().length) {
                const filters = this['filters']().map(dd => dd.toString());
                if (_.includes(filters, d.key.toString())) {
                    return 1;
                }
                else {
                    return .1;
                }
            }
            else {
                return null;
            }
        })
            .attr('text-anchor', 'middle')
            .attr('transform', (d) => 'translate(' + [d.x, d.y] + ')rotate(' + d.rotate + ')')
            .text((d) => d.text);
        // @ts-ignore
        cloud.on('click', (d, i) => {
            const { key, value } = d;
            this['onClick']({ key, value }, i);
        });
        if (this.option && this.option.tooltip) {
            const tooltip = this.getTooltipElem();
            cloud
                .on('mouseover', data => {
                // @ts-ignore
                const screenX = event.view.innerWidth;
                // @ts-ignore
                const screenY = event.view.innerHeight;
                // @ts-ignore
                const pageX = event.pageX;
                // @ts-ignore
                const pageY = event.pageY;
                const toolX = tooltip.node().clientWidth;
                const toolY = tooltip.node().clientHeight;
                let left = 0, top = 0;
                tooltip.transition()
                    .duration(200)
                    .style('opacity', .9);
                tooltip.html(this.option.tooltip(data));
                setTimeout(() => {
                    if ((screenX - pageX) < tooltip.node().clientWidth) {
                        left = pageX - toolX - 12;
                        tooltip.classed('right', true);
                        tooltip.classed('left', false);
                    }
                    else {
                        left = pageX + 12;
                        tooltip.classed('right', false);
                        tooltip.classed('left', true);
                    }
                    if ((screenY - pageY) < tooltip.node().clientHeight) {
                        top = pageY - toolY + 10;
                        tooltip.classed('bottom', true);
                        tooltip.classed('top', false);
                    }
                    else {
                        top = pageY - 10;
                        tooltip.classed('bottom', false);
                        tooltip.classed('top', true);
                    }
                    tooltip
                        .style('top', top + 'px')
                        .style('left', left + 'px');
                });
            })
                .on('mouseout', data => {
                tooltip.transition()
                    .duration(500)
                    .style('opacity', 0);
            });
        }
    }
    getTooltipElem() {
        if (!this._tooltip || this._tooltip.empty()) {
            this._tooltip = d3.select('body')
                .append('div')
                .attr('class', 'wise-chart-tooltip')
                .html('')
                .style('opacity', 0)
                .style('position', 'absolute');
        }
        return this._tooltip;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xvdWQtY2hhcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9kai1hbmd1bGFyLWNoYXJ0L3NyYy9saWIvY2hhcnQvY2xvdWQtY2hhcnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxLQUFLLFFBQVEsTUFBTSxVQUFVLENBQUM7QUFDckMsT0FBTyxLQUFLLENBQUMsTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBQzdDLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQztBQUd6QixNQUFNLE9BQU8sVUFBVyxTQUFRLFNBQVM7SUFTdkMsWUFBb0IsT0FBYSxFQUFVLE1BQVk7UUFDckQsS0FBSyxFQUFFLENBQUM7UUFEVSxZQUFPLEdBQVAsT0FBTyxDQUFNO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBTTtRQVAvQyxXQUFNLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDbEIsV0FBTSxHQUFHLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQztRQUU3QixhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBT25CLElBQUksQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDO1FBQ2xCLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxNQUFNO1FBQ0osSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDZCxhQUFhO1lBQ2IsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ3JCO1FBQ0QsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25CLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELE1BQU07UUFDSixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7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QUM7U0FDTjtJQUNILENBQUM7SUFHTyxjQUFjO1FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFFBQVEsR0FBSSxFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztpQkFDL0IsTUFBTSxDQUFDLEtBQUssQ0FBQztpQkFDYixJQUFJLENBQUMsT0FBTyxFQUFFLG9CQUFvQixDQUFDO2lCQUNuQyxJQUFJLENBQUMsRUFBRSxDQUFDO2lCQUNSLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO2lCQUNuQixLQUFLLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1NBQ2xDO1FBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3ZCLENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGQzIGZyb20gJ2QzJztcbmltcG9ydCAqIGFzIF9kM0Nsb3VkIGZyb20gJ2QzLWNsb3VkJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7QmFzZU1peGlufSBmcm9tICcuLi9iYXNlL2Jhc2UtbWl4aW4nO1xuY29uc3QgZDNDbG91ZCA9IF9kM0Nsb3VkO1xuXG5cbmV4cG9ydCBjbGFzcyBDbG91ZENoYXJ0IGV4dGVuZHMgQmFzZU1peGluIHtcblxuICBwcml2YXRlIF9zY2FsZSA9IFsxNSwgNzBdO1xuICBwcml2YXRlIF9jb2xvciA9IGQzLnNjaGVtZUNhdGVnb3J5MTA7XG4gIHByaXZhdGUgX2N1c3RvbUNvbG9yOiBhbnk7XG4gIHByaXZhdGUgX3BhZGRpbmcgPSAyO1xuICBwcml2YXRlIF9sZWdlbmRzOiBhbnk7XG4gIHByaXZhdGUgX3Rvb2x0aXA6IGFueTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnQ/OiBhbnksIHByaXZhdGUgb3B0aW9uPzogYW55KSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuX3dpZHRoID0gMTAwO1xuICAgIHRoaXMuX2hlaWdodCA9IDEwMDtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBpZiAodGhpcy5zdmcoKSkge1xuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgdGhpcy5zdmcoKS5yZW1vdmUoKTtcbiAgICB9XG4gICAgdGhpcy5jaGFydFJlbmRlcigpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcmVkcmF3KCkge1xuICAgIHRoaXMucmVuZGVyKCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB3aWR0aCh3aWR0aD86IG51bWJlcikge1xuICAgIGlmICghd2lkdGgpIHtcbiAgICAgIHRoaXMuX3dpZHRoID0gdGhpcy5vcHRpb24ud2lkdGggPyB0aGlzLm9wdGlvbi53aWR0aCA6IHRoaXMuZWxlbWVudC5jbGllbnRXaWR0aDtcbiAgICAgIHJldHVybiB0aGlzLl93aWR0aDtcbiAgICB9XG5cbiAgICB0aGlzLl93aWR0aCA9IHdpZHRoO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgaGVpZ2h0KGhlaWdodD86IG51bWJlcikge1xuICAgIGlmICghaGVpZ2h0KSB7XG4gICAgICB0aGlzLl9oZWlnaHQgPSB0aGlzLm9wdGlvbi5oZWlnaHQgPyB0aGlzLm9wdGlvbi5oZWlnaHQgOiB0aGlzLmVsZW1lbnQuY2xpZW50SGVpZ2h0O1xuICAgICAgcmV0dXJuIHRoaXMuX2hlaWdodDtcbiAgICB9XG4gICAgdGhpcy5faGVpZ2h0ID0gaGVpZ2h0O1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgbGVnZW5kcyhvYmplY3Q/OiBhbnkpIHtcbiAgICBpZiAoIW9iamVjdCkge1xuICAgICAgcmV0dXJuIHRoaXMuX2xlZ2VuZHM7XG4gICAgfVxuICAgIHRoaXMuX2xlZ2VuZHMgPSBvYmplY3Q7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwYWRkaW5nKHBhZGRpbmc/OiBhbnkpIHtcbiAgICBpZiAoIXBhZGRpbmcpIHtcbiAgICAgIHJldHVybiB0aGlzLl9wYWRkaW5nO1xuICAgIH1cbiAgICB0aGlzLl9wYWRkaW5nID0gcGFkZGluZztcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGNvbG9yKGNvbG9yPzogYW55KSB7XG4gICAgaWYgKCFjb2xvcikge1xuICAgICAgcmV0dXJuIHRoaXMuX2N1c3RvbUNvbG9yID8gdGhpcy5fY3VzdG9tQ29sb3IgOiB0aGlzLl9jb2xvcjtcbiAgICB9XG4gICAgdGhpcy5fY3VzdG9tQ29sb3IgPSBjb2xvcjtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGRpbWVuc2lvbihkaW1lbnNpb246IGFueSkge1xuICAgIGlmICghZGltZW5zaW9uKSB7XG4gICAgICByZXR1cm4gdGhpcy5fZGltZW5zaW9uO1xuICAgIH1cbiAgICB0aGlzLl9kaW1lbnNpb24gPSBkaW1lbnNpb247XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBncm91cChvYmplY3Q6IGFueSkge1xuICAgIGlmICghb2JqZWN0KSB7XG4gICAgICByZXR1cm4gdGhpcy5fZ3JvdXA7XG4gICAgfVxuICAgIHRoaXMuX2dyb3VwID0gb2JqZWN0O1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cblxuXG4gIHByaXZhdGUgY2hhcnRSZW5kZXIoKSB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLl9ncm91cC5hbGwoKTtcbiAgICBjb25zdCBmb250U2NhbGUgPSBkMy5zY2FsZUxpbmVhcigpLnJhbmdlKHRoaXMuX3NjYWxlKTtcbiAgICBjb25zdCBkb21haW4gPSBbZDMubWluKGRhdGEsIChkOiBhbnkpID0+IGQudmFsdWUpLCBkMy5tYXgoZGF0YSwgKGQ6IGFueSkgPT4gZC52YWx1ZSldO1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBmb250U2NhbGUuZG9tYWluKGRvbWFpbik7XG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgZDNDbG91ZCgpXG4gICAgICAuc2l6ZShbdGhpcy5fd2lkdGgsIHRoaXMuX2hlaWdodF0pXG4gICAgICAud29yZHMoZGF0YSlcbiAgICAgIC5wYWRkaW5nKHRoaXMuX3BhZGRpbmcpXG4gICAgICAucm90YXRlKDApXG4gICAgICAuZm9udCgnc2Fucy1zZXJpZicpXG4gICAgICAudGV4dCgoZDogYW55KSA9PiB7XG4gICAgICAgIGxldCBrZXkgPSBkLmtleSB8fCBkLmtleXM7XG4gICAgICAgIGtleSA9IHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnID8ga2V5IDoga2V5WzBdO1xuICAgICAgICBpZiAodGhpcy5fbGVnZW5kcyAmJiB0aGlzLl9sZWdlbmRzW2tleV0pIHtcbiAgICAgICAgICBrZXkgPSB0aGlzLl9sZWdlbmRzW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGtleTtcbiAgICAgIH0pXG4gICAgICAuZm9udFNpemUoKGQ6IGFueSkgPT4gZm9udFNjYWxlKGQudmFsdWUpKVxuICAgICAgLm9uKCdlbmQnLCB0aGlzLmRyYXcuYmluZCh0aGlzKSlcbiAgICAgIC5zdGFydCgpO1xuICB9XG5cbiAgc3ZnKCkge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBpZiAoIWQzLnNlbGVjdCh0aGlzLmVsZW1lbnQpLnNlbGVjdCgnc3ZnJykuX2dyb3Vwc1swXVswXSkge1xuICAgICAgcmV0dXJuIDtcbiAgICB9XG4gICAgcmV0dXJuIGQzLnNlbGVjdCh0aGlzLmVsZW1lbnQpLnNlbGVjdCgnc3ZnJyk7XG4gIH1cblxuICBwcml2YXRlIGRyYXcod29yZHM6IGFueSkge1xuICAgIGNvbnN0IGNsb3VkID0gZDMuc2VsZWN0KHRoaXMuZWxlbWVudCkuYXBwZW5kKCdzdmcnKVxuICAgICAgLmF0dHIoJ2NsYXNzJywgJ3dpc2UtY2hhcnQtY2xvdWQnKVxuICAgICAgLmF0dHIoJ3dpZHRoJywgdGhpcy5fd2lkdGgpXG4gICAgICAuYXR0cignaGVpZ2h0JywgdGhpcy5faGVpZ2h0KVxuICAgICAgLmFwcGVuZCgnZycpXG4gICAgICAuYXR0cigndHJhbnNmb3JtJywgJ3RyYW5zbGF0ZSgnICsgdGhpcy5fd2lkdGggLyAyICsgJywnICsgdGhpcy5faGVpZ2h0IC8gMiArICcpJylcbiAgICAgIC5zZWxlY3RBbGwoJ3RleHQnKVxuICAgICAgLmRhdGEod29yZHMpXG4gICAgICAuZW50ZXIoKS5hcHBlbmQoJ3RleHQnKVxuICAgICAgLnN0eWxlKCdmb250LXNpemUnLCAoZDogYW55KSA9PiBkLnNpemUgKyAncHgnKVxuICAgICAgLnN0eWxlKCdmb250LWZhbWlseScsICdzYW5zLXNlcmlmJylcbiAgICAgIC5zdHlsZSgnZmlsbCcsIChkOiBhbnksIGk6IG51bWJlcikgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5fY3VzdG9tQ29sb3IgPyB0aGlzLl9jdXN0b21Db2xvcltkLmtleVswXV0gOiB0aGlzLl9jb2xvclsgaSAlIHRoaXMuX2NvbG9yLmxlbmd0aF07XG4gICAgICB9KVxuICAgICAgLnN0eWxlKCdvcGFjaXR5JywgKGQ6IGFueSwgaSkgPT4ge1xuICAgICAgICBpZiAodGhpc1snZmlsdGVycyddKCkubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3QgZmlsdGVycyA9IHRoaXNbJ2ZpbHRlcnMnXSgpLm1hcChkZCA9PiBkZC50b1N0cmluZygpKTtcbiAgICAgICAgICBpZiAoXy5pbmNsdWRlcyhmaWx0ZXJzLCBkLmtleS50b1N0cmluZygpKSkge1xuICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiAuMTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuYXR0cigndGV4dC1hbmNob3InLCAnbWlkZGxlJylcbiAgICAgIC5hdHRyKCd0cmFuc2Zvcm0nLCAoZDogYW55KSA9PiAndHJhbnNsYXRlKCcgKyBbZC54LCBkLnldICsgJylyb3RhdGUoJyArIGQucm90YXRlICsgJyknKVxuICAgICAgLnRleHQoKGQ6IGFueSkgPT4gZC50ZXh0KTtcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjbG91ZC5vbignY2xpY2snLCAoZDogYW55LCBpOiBudW1iZXIpID0+IHtcbiAgICAgIGNvbnN0IHtrZXksIHZhbHVlfSA9IGQ7XG4gICAgICB0aGlzWydvbkNsaWNrJ10oe2tleSwgdmFsdWV9LCBpKTtcbiAgICB9KTtcblxuICAgIGlmICh0aGlzLm9wdGlvbiAmJiB0aGlzLm9wdGlvbi50b29sdGlwKSB7XG4gICAgICBjb25zdCB0b29sdGlwID0gdGhpcy5nZXRUb29sdGlwRWxlbSgpO1xuICAgICAgY2xvdWRcbiAgICAgICAgLm9uKCdtb3VzZW92ZXInLCBkYXRhID0+IHtcbiAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgY29uc3Qgc2NyZWVuWCA9IGV2ZW50LnZpZXcuaW5uZXJXaWR0aDtcbiAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgY29uc3Qgc2NyZWVuWSA9IGV2ZW50LnZpZXcuaW5uZXJIZWlnaHQ7XG4gICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgIGNvbnN0IHBhZ2VYID0gZXZlbnQucGFnZVg7XG4gICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgIGNvbnN0IHBhZ2VZID0gZXZlbnQucGFnZVk7XG4gICAgICAgICAgY29uc3QgdG9vbFggPSB0b29sdGlwLm5vZGUoKS5jbGllbnRXaWR0aDtcbiAgICAgICAgICBjb25zdCB0b29sWSA9IHRvb2x0aXAubm9kZSgpLmNsaWVudEhlaWdodDtcbiAgICAgICAgICBsZXQgbGVmdCA9IDAsIHRvcCA9IDA7XG5cbiAgICAgICAgICB0b29sdGlwLnRyYW5zaXRpb24oKVxuICAgICAgICAgICAgLmR1cmF0aW9uKDIwMClcbiAgICAgICAgICAgIC5zdHlsZSgnb3BhY2l0eScsIC45KTtcbiAgICAgICAgICB0b29sdGlwLmh0bWwodGhpcy5vcHRpb24udG9vbHRpcChkYXRhKSk7XG5cbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIGlmICgoc2NyZWVuWCAtIHBhZ2VYKSA8IHRvb2x0aXAubm9kZSgpLmNsaWVudFdpZHRoKSB7XG4gICAgICAgICAgICAgIGxlZnQgPSBwYWdlWCAtIHRvb2xYIC0gMTI7XG4gICAgICAgICAgICAgIHRvb2x0aXAuY2xhc3NlZCgncmlnaHQnLCB0cnVlKTtcbiAgICAgICAgICAgICAgdG9vbHRpcC5jbGFzc2VkKCdsZWZ0JywgZmFsc2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbGVmdCA9IHBhZ2VYICsgMTI7XG4gICAgICAgICAgICAgIHRvb2x0aXAuY2xhc3NlZCgncmlnaHQnLCBmYWxzZSk7XG4gICAgICAgICAgICAgIHRvb2x0aXAuY2xhc3NlZCgnbGVmdCcsIHRydWUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoKHNjcmVlblkgLSBwYWdlWSkgPCB0b29sdGlwLm5vZGUoKS5jbGllbnRIZWlnaHQpIHtcbiAgICAgICAgICAgICAgdG9wID0gcGFnZVkgLSB0b29sWSArIDEwO1xuICAgICAgICAgICAgICB0b29sdGlwLmNsYXNzZWQoJ2JvdHRvbScsIHRydWUpO1xuICAgICAgICAgICAgICB0b29sdGlwLmNsYXNzZWQoJ3RvcCcsIGZhbHNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRvcCA9IHBhZ2VZIC0gMTA7XG4gICAgICAgICAgICAgIHRvb2x0aXAuY2xhc3NlZCgnYm90dG9tJywgZmFsc2UpO1xuICAgICAgICAgICAgICB0b29sdGlwLmNsYXNzZWQoJ3RvcCcsIHRydWUpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0b29sdGlwXG4gICAgICAgICAgICAgIC5zdHlsZSgndG9wJywgdG9wICsgJ3B4JylcbiAgICAgICAgICAgICAgLnN0eWxlKCdsZWZ0JywgbGVmdCArICdweCcpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICAgICAub24oJ21vdXNlb3V0JywgZGF0YSA9PiB7XG4gICAgICAgICAgdG9vbHRpcCAudHJhbnNpdGlvbigpXG4gICAgICAgICAgICAuZHVyYXRpb24oNTAwKVxuICAgICAgICAgICAgLnN0eWxlKCdvcGFjaXR5JywgMCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG5cbiAgcHJpdmF0ZSBnZXRUb29sdGlwRWxlbSgpIHtcbiAgICBpZiAoIXRoaXMuX3Rvb2x0aXAgfHwgdGhpcy5fdG9vbHRpcC5lbXB0eSgpKSB7XG4gICAgICB0aGlzLl90b29sdGlwICA9IGQzLnNlbGVjdCgnYm9keScpXG4gICAgICAgIC5hcHBlbmQoJ2RpdicpXG4gICAgICAgIC5hdHRyKCdjbGFzcycsICd3aXNlLWNoYXJ0LXRvb2x0aXAnKVxuICAgICAgICAuaHRtbCgnJylcbiAgICAgICAgLnN0eWxlKCdvcGFjaXR5JywgMClcbiAgICAgICAgLnN0eWxlKCdwb3NpdGlvbicsICdhYnNvbHV0ZScpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fdG9vbHRpcDtcbiAgfVxuXG59XG4iXX0=